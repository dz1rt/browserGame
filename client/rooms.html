<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Создание комнаты</title>
		 <link rel="stylesheet" href="style.css">
		 <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
	</head>
	<body id="body">
		<input id="drawBtn" type="button" onclick="createRoom();" value="Create Room">
		<!-- <canvas id="monopoly_game"></canvas>
		<input id="drawBtn" type="button" value="Draw">
		<input id="clearBtn" type="button" value="Clear">-->
	</body>
	<script>
		//проверка на комнаты, которые активны
		setInterval(function() {
			//создаем ajax запрос
			$.ajax({
				url: "api/users", //к юзерам
				contentType: "application/json",
				method: "POST",
				data: JSON.stringify({
					type: 4
				}),
				success: function (answer) {
					if (answer != false) {
						var elementsLink = document.getElementsByClassName("connectLink");
						for (var i=0; i<answer.length; i++) {
							//добавдяем комнату
							addRoom(answer[i].idr);
						}
						//удалить ненужные кнопки
						for (var i=0; i<elementsLink.length; i++) {
							var check = false; //изначально не найден элемент
							//идем по всем существующим комнатам
							for (var j=0; j<answer.length; j++) {
								if (elementsLink[i].getAttribute("data-idr") == answer[j].idr && !answer[j].isPlay) {
									check = true; //нашли
								}
							}
							//если совпадений нет, то удалить элемент
							if (!check) {
								var elem = document.getElementById("roomLink");
								elem.parentNode.removeChild(elem);
							}
						} 
						//Создаем кнопку коннекта к данной комнате
						//создание "виртуального образа" кнопки
						//document.location.href = "game.html?idr="+answer;
					}
				}
			})
		}, 1000);
		
		//добавление html кода при обновлении комнаты
		function addRoom(_idr) {
			var elementP = document.getElementsByClassName("connectLink");
			var check = true;
			//проверяем все ссылки на коннект с комнатами
			//если элемент есть, то не рисовать новый
			for (var i=0; i<elementP.length; i++) {
				if (elementP[i].getAttribute("data-idr") == _idr){
					check = false;
				}
			}
			//если нет, то рисуем
			if (check) {
				var str = '<div class="connectLinks">\<input type="button" id="roomLink" class="connectLink" value="Зайти" onclick="attachRoom(\''+_idr.toString()+'\');" data-idr="'+_idr+'"></input></div>';
				var div = document.createElement('div');
				div.innerHTML = str;
				document.body.appendChild(div);
			}
		}
		
		//Проверка на входе, при удачном входе вернется true
		function createRoom() {
			//создаем ajax запрос
			$.ajax({
				url: "api/users", //к юзерам
				contentType: "application/json",
				method: "POST",
				data: JSON.stringify({
					type: 2,
					sh: sessionStorage.getItem("sh")
				}),
				success: function (answer) {
					//если удачно, то переходим в комнату
					if (answer != false) {
						//Создаем кнопку коннекта к данной комнате
						// создание "виртуального образа" кнопки
						document.location.href = "game.html?idr="+answer;
					}
				}
			})
		}
		
		//Присоединиться к комнате
		function attachRoom(_idr) {
			//создаем ajax запрос
			console.log(_idr);
			$.ajax({
				url: "api/users", //к юзерам
				contentType: "application/json",
				method: "POST",
				data: JSON.stringify({
					type: 3,
					sh: sessionStorage.getItem("sh"),
					idr: _idr
				}),
				success: function (answer) {
					//если удачно, то переходим в комнату
					if (answer != false) {
						
						//document.location.href = "game.html?idr="+answer;
					}
				}
			})
		}
	</script>
</html>